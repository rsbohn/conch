# Development Log - August 14, 2025

## Building the Conch TUI

Today was an intensive session building and refining the Conch TUI from scratch. Starting with a basic Textual application that wouldn't even run, we ended up with a polished, feature-rich terminal interface.

## The Challenge

The user wanted to run `uv run python main.py` but encountered immediate issues:
- `TextLog` import errors due to Textual version incompatibilities
- CSS parsing failures with invalid comment syntax
- Attribute naming conflicts with Textual's internal properties
- Process hanging issues with background tasks
- Ctrl+C not working in Windows Terminal with PowerShell

## Solutions Implemented

### 1. Textual Compatibility Issues

**Problem**: `TextLog` was not available in the installed Textual version.

**Solution**: Created a compatibility layer that evolved through several iterations:
- Started with `ScrollView` (also not available)
- Moved to `Static` with manual scrolling
- Finally settled on `RichLog` - the proper widget for logging output

### 2. CSS Syntax Errors

**Problem**: Textual CSS doesn't accept `#` comment lines like regular CSS.

**Solution**: Replaced invalid comment syntax:
```css
/* Before - Invalid */
# This is a comment
#

/* After - Valid */
/* This is a comment */
```

### 3. Attribute Conflicts

**Problem**: Using `self.log` conflicted with Textual's built-in `App.log` property.

**Solution**: Renamed to `self.log_view` throughout the codebase.

### 4. Process Hanging Issues

**Problem**: The `--test` flag worked initially but then processes wouldn't terminate cleanly.

**Solution**: Multiple approaches were tried:
- Added stdin EOF watcher (caused more problems)
- Used `asyncio.to_thread` with daemon threads (still problematic)
- **Final solution**: Removed the stdin watcher entirely and simplified exit paths

**Problem**: Method naming conflicts with framework internals.

**Solution**: Renamed `_shutdown()` to `_test_auto_exit()` and created `_test_delayed_exit()` for the 2-second delay.

### 5. Ctrl+C Handling

**Problem**: Ctrl+C wasn't working in Windows Terminal with PowerShell when using `uv run`.

**Solutions implemented**:
- Added explicit Ctrl+C key handler in `on_key()`
- Installed SIGINT signal handler in `main()`
- Added fallback keyboard interrupt handling
- Made exit functions handle both coroutine and non-coroutine Textual versions

### 6. Piped Input Handling

**Problem**: `echo "test" | uv run python main.py` would hang indefinitely.

**Solution**: Added stdin detection in `main.py`:
```python
if not sys.stdin.isatty():
    print("Hello from conch!")
    print("(Non-interactive mode - stdin is piped)")
    return
```

### 7. Directory Listing Feature

**Enhancement**: Extended the `< filename` command to handle directories.

**Implementation**: Added directory detection using `os.path.isdir()` that:
- Lists directory contents with trailing `/` for subdirectories
- Sorts entries alphabetically
- Sets title to just the directory name

**Bug Fix**: Resolved `os` import scoping issue:
- Problem: Had redundant `import os` inside function after using `os.path.isdir()`
- Solution: Removed redundant import since `os` was already imported at module level
- Error message: "cannot access local variable 'os' where it is not associated with a value"

## Feature Development

### Core Architecture

**LogView Class**: Custom widget extending `RichLog` with:
- `append()` method for adding lines
- `clear()` method for clearing content
- `set_title()` method for dynamic titles
- Automatic scrolling to bottom
- No focus capability (users can't accidentally focus it)

**Layout**: 80% height for log area, remaining space for input field

### Command System

**Slash Commands**:
- `/help` - Comprehensive help system with centralized `HELP_TEXT`
- `/q`, `/quit` - Exit application
- `/clear`, `/cls` - Clear log and reset title
- `/lorem` - Add test text for scrolling verification

**File Commands**:
- `< filename` - Read and display file contents with error handling
- `< directory` - List directory contents with trailing `/` for subdirectories

**Shell Commands** (existing):
- `> sh: command` or `sh: command` - Execute shell commands

### User Experience Enhancements

**Dynamic Titles**: 
- Default: "Conch TUI"
- File display: Shows just filename (e.g., "README.md")
- Styled with bold cyan, centered alignment

**Input Field Management**:
- All slash commands clear input after execution
- Consistent behavior across all command types

**Error Handling**:
- File not found errors
- Permission denied errors
- Binary file detection
- Generic exception handling

**Visual Polish**:
- Proper CSS styling with working border titles
- 80% height constraint prevents log overflow
- Scrollable content with auto-scroll to bottom
- Clean borders and color scheme

## Technical Lessons Learned

### 1. Textual Widget Selection
- `Static` is not suitable for scrollable log content
- `RichLog` is purpose-built for logging with proper performance
- Always check widget compatibility across Textual versions

### 2. CSS Property Names
- Textual CSS property names are specific (e.g., `border-title-align` not `title-align`)
- Style and color must be separate properties
- Comment syntax matters - use `/* */` not `#`

### 3. Process Management
- Background asyncio tasks can prevent clean process termination
- Daemon threads are helpful but not a complete solution
- Sometimes simpler is better - removed complex stdin watching

### 4. Cross-Platform Considerations
- Windows Terminal + PowerShell + uv has specific signal handling behavior
- Multiple fallback mechanisms needed for reliable Ctrl+C
- stdin.isatty() detection crucial for piped input scenarios

### 5. Framework Integration
- Avoid naming conflicts with framework internals
- Handle both coroutine and non-coroutine framework methods
- Graceful degradation when optional features aren't available

## Final Result

A fully functional TUI with:
- ✅ Reliable startup and shutdown
- ✅ Cross-platform Ctrl+C handling  
- ✅ Comprehensive command system
- ✅ File reading capabilities
- ✅ Directory listing capabilities
- ✅ Dynamic title management
- ✅ Proper error handling
- ✅ Professional visual design
- ✅ 80% height constraint with scrolling
- ✅ Help system and user guidance

The `--test` flag now works perfectly for automated testing, and the interactive mode provides a rich, discoverable interface for users.

## Commands Available

```
Available Commands:
  /help           - Show this help message
  /q, /quit       - Exit the application
  /clear, /cls    - Clear the log display
  /lorem          - Add sample text for testing scrolling

File Commands:
  < filename      - Read and display file contents (e.g., "< README.md")
  < directory     - List directory contents (e.g., "< src")

Shell Commands:
  > sh: <command> - Execute a shell command (e.g., "> sh: ls -la")
  sh: <command>   - Same as above, shorthand version

Keyboard Shortcuts:
  Ctrl+C          - Exit the application
  Ctrl+L          - Clear the log display
```

## Next Steps

The TUI is now stable and feature-complete for the core use cases. Future enhancements could include:
- Syntax highlighting for file display
- Command history with up/down arrows
- Configuration file support
- Plugin system for custom commands
- Improved shell command output formatting

This was a great example of iterative development - starting with a broken foundation and systematically addressing each issue until we had a polished, professional result.
