# Devlog: Anthropic tool-use loop and 400 error fix (2025-09-04)

## Context
Goal: wire up Anthropic Messages API tool-use in a minimal conversation demo and answer a query that triggers a tool invocation.

Primary file: [src/scripts/conversation_demo.py](../src/scripts/conversation_demo.py)

## What happened
- Initial run produced a tool_use response from the model but the script didn’t have a loop to execute tools and continue the exchange.
- First attempt to send tool results used a `role: "tool"` message, which Anthropic rejects.
- The API returned a 400:
  - “Unexpected role 'tool'. Allowed roles are 'user' or 'assistant'.”

## Decisions and fixes
- Tool result role: Anthropic expects tool results as a `user` role message that contains a `tool_result` content block with the matching `tool_use_id`.
  - Implemented by constructing a user message with `{"type": "tool_result", "tool_use_id": ..., "content": ...}`.
- Conversation flow:
  - Append the assistant’s tool_use content back into the transcript so the model can track state.
  - Append one user tool_result message per tool_use block returned by the assistant.
  - Call the API again to let the model produce the final answer.
- Looping:
  - Current script performs a single tool round-trip; consider generalizing to a small loop (e.g., up to 3–4 iterations) for multi-step tool chains.
- Error handling:
  - Current error path returns a list with an `{"error": ...}` dict. This shape differs from normal responses and complicates downstream handling. Standardize to a dict with `stop_reason: "exception"` and a simple text block to keep the shape consistent.

## Notable details
- The rulebook includes an exception about “sunglasses,” and the personae mention the Cheshire Cat wearing sunglasses. This provides a fun edge case for the tool and persona grounding.
- Kept model: `claude-3-5-haiku-20241022`.
- System prompt includes serialized `personae` for clarity and grounding.

## Relevant code locations (no snippets)
- Anthropics call and tool wiring: `actual_claude(...)` in [conversation_demo.py](../src/scripts/conversation_demo.py)
- Tool execution and tool_result message: `_tool(...)` in [conversation_demo.py](../src/scripts/conversation_demo.py)
- Rule source data: `rulebook(...)` in [conversation_demo.py](../src/scripts/conversation_demo.py)
- One-round tool handling in `__main__` block: [conversation_demo.py](../src/scripts/conversation_demo.py)

## How to run (Windows PowerShell)
- Activate venv: `.\.venv\Scripts\Activate.ps1`
- Install deps (uv): `uv pip install anthropic`
- Set API key: `$env:ANTHROPIC_API_KEY = "sk-ant-..."`
- Run: `uv run python .\src\scripts\conversation_demo.py`

## Remaining technical debt / next steps
- Standardize error return shape from `actual_claude(...)`.
- Support multiple tool rounds with a small iteration cap.
- Add pytest coverage:
  - Tool round-trip flow (mock anthropic client).
  - `_tool(...)` behavior for known/unknown tools.
  - `rulebook(...)` content and formatting.
- Apply Black and PEP 8 pass.
- Expand docs:
  - Developer guide: notes on tool message shapes and loop patterns.
  - User guide: how to run, set env vars, and expected behavior.

```python
    rules = [
        "1. Be respectful and polite.",
        "2. Provide accurate information.",
        "3. If you don't know the answer, say so.",
        "4. Keep responses concise and to the point.",
        "5. Do not under any circumstances look at the queen.",
        "(Unless you are wearing sunglasses.)"
    ]
```

Based on the rulebook, it appears that looking directly at the queen is strictly forbidden, with one exception: if you are wearing sunglasses. Interestingly, the Cheshire Cat is currently wearing sunglasses, which might suggest they have a special privilege.

The rule seems to emphasize the queen's importance and the need to show her utmost respect. So, unless you have sunglasses on, it would be advisable not to look directly at the queen